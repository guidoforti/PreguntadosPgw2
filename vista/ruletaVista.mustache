<div class="container my-5 text-center">
    <h1 class="display-4">¡Gira la ruleta!</h1>

    <div id="ruleta-wrapper" class="my-4">
        <div id="ruleta-puntero">▼</div>
        <canvas id="miRuleta" width="450" height="450">
            Tu navegador no soporta Canvas.
        </canvas>
    </div>

    <button id="botonGirar" class="btn btn-primary btn-lg px-5 d-block mx-auto">
        ¡GIRAR!
    </button>

    <form id="formRuleta" action="/jugarPartida/guardarCategoria" method="POST" class="d-none">
        <input type="hidden" name="categoria_elegida" id="categoria_elegida">
    </form>

</div>

<style>

    #ruleta-wrapper {
        position: relative;
        display: inline-block;
    }

    /* El puntero (flecha) */
    #ruleta-puntero {
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 99;


        font-size: 40px;
        color: #333;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/zarocknz/javascript-winwheel@2.8.0/Winwheel.min.js"></script>

<script>
    const categoriasJSON = '{{{ categorias_json }}}';
    const categorias = JSON.parse(categoriasJSON);

    let segmentos = categorias.map(cat => {
        return {
            'fillStyle': cat.color_hex,
            'text': cat.nombre
        };
    });

    console.log(segmentos);


    function ruletaTermino(segmentoElegido) {
        console.log('Callback ejecutado:', segmentoElegido);
        let categoriaElegida = segmentoElegido.text;

        Swal.fire({
            title: 'Categoria: ' + categoriaElegida,
            text: 'Las próximas 2 preguntas serán de esta categoría.',
            icon: 'info',
            confirmButtonText: '¡Vamos!'
        }).then((result) => {
            document.getElementById('categoria_elegida').value = categoriaElegida;
            document.getElementById('formRuleta').submit();
        });
    }

    let ruleta = new Winwheel({
        'canvasId'      :   'miRuleta',
        'pointerAngle'  :   0,
        'numSegments'   :   segmentos.length,
        'outerRadius'   :   212,
        'textFontSize'  :   16,
        'segments'      :   segmentos,
        'animation'     :
                        {
                            'type'              :   'spinToStop',
                            'duration'          :   5,
                            'spins'             :   3,
                            'callbackFinished'  :   ruletaTermino
                        }
    });

    const botonGirar = document.getElementById('botonGirar');
    let girando = false;

    botonGirar.addEventListener('click', () => {
        if (!girando){
            girando = true;
            botonGirar.innerText = 'Girando...';
            botonGirar.disabled = true;

            ruleta.startAnimation();
        }
    });
    const mensajePenalizacion = '{{mensaje_penalizacion}}';

    if (mensajePenalizacion.length > 0) {
        setTimeout(() => {
            Swal.fire({
                title: '¡Partida Abandonada!',
                text: mensajePenalizacion,
                icon: 'error',
                confirmButtonText: 'Continuar',
                allowOutsideClick: false,
                allowEscapeKey: false
            });
        }, 100);
    }
</script>

