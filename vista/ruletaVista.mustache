<div class="container my-5 text-center">
    <h1 class="display-4">¡Gira la ruleta!</h1>

    <div id="ruleta-wrapper" class="my-4">
        <div id="ruleta-puntero">▼</div>
        <canvas id="miRuleta" width="450" height="450">
            Tu navegador no soporta Canvas.
        </canvas>
    </div>

    <button id="botonGirar" class="btn btn-primary btn-lg px-5 d-block mx-auto">
        ¡GIRAR!
    </button>

    <form id="formRuleta" action="/jugarPartida/guardarCategoria" method="POST" class="d-none">
        <input type="hidden" name="categoria_elegida" id="categoria_elegida">
    </form>

</div>

<style>

    #ruleta-wrapper {
        position: relative;
        display: inline-block;
    }

    #ruleta-puntero {
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 99;


        font-size: 40px;
        color: #333;
    }
</style>

<script>
    {
        const categoriasJSON = '{{{ categorias_json }}}';
        const categorias = JSON.parse(categoriasJSON);

        let segmentos = categorias.map(cat => {
            return {
                'id': cat.categoria_id,
                'fillStyle': cat.color_hex,
                'text': cat.nombre
            };
        });

        console.log(segmentos);

        function ruletaTermino(segmentoElegido) {
            Swal.fire({
                title: 'Categoría: ' + segmentoElegido.text,
                text: 'Las próximas 2 preguntas serán de esta categoría.',
                icon: 'info',
                confirmButtonText: '¡Vamos!'
            }).then(() => {
                fetch('/jugarPartida/guardarCategoria', {
                    method: 'POST'
                })
                        .then(response => {
                            loadView('/jugarPartida/mostrarPregunta');
                        })
                        .catch(error => {
                            console.error("Error al avanzar:", error);
                            window.location.href = 'jugarPartida/mostrarPregunta';
                        });
            });
        }

        setTimeout(() => {
            let miRuletaLocal = new Winwheel({
                'canvasId': 'miRuleta',
                'pointerAngle': 0,
                'numSegments': segmentos.length,
                'outerRadius': 212,
                'textFontSize': 16,
                'segments': segmentos,
                'animation':
                        {
                            'type': 'spinToStop',
                            'duration': 9,
                            'spins': 6,
                            'callbackFinished': ruletaTermino
                        }
            });

            const botonGirar = document.getElementById('botonGirar');
            let girando = false;

            botonGirar.addEventListener('click', () => {
                if (!girando) {
                    soundManager.play('wheel');
                    girando = true;
                    botonGirar.innerText = 'Girando...';
                    botonGirar.disabled = true;
                    fetch('/jugarPartida/obtenerCategoriaParaGiro', {method: 'POST'})
                            .then(r => r.json())
                            .then(categoria => {
                                if (categoria.error) throw new Error(categoria.error);

                                let segIndex = -1;
                                for (let i = 1; i <= miRuletaLocal.numSegments; i++) {
                                    const s = miRuletaLocal.segments[i];
                                    if (s && s.id === categoria.categoria_id) {
                                        segIndex = i;
                                        break;
                                    }
                                }
                                if (segIndex === -1) {
                                    console.error('No se encontró el segmento para la categoría', categoria);
                                    miRuletaLocal.startAnimation();
                                    return;
                                }

                                const stopAt = miRuletaLocal.getRandomForSegment(segIndex);
                                miRuletaLocal.animation.stopAngle = stopAt;
                                miRuletaLocal.startAnimation();
                            })
                            .catch(err => {
                                console.error('Error al obtener categoría:', err);
                                Swal.fire('Error', 'No se pudo obtener la categoría, intenta de nuevo.', 'error');
                                girando = false;
                                botonGirar.innerText = '¡GIRAR!';
                                botonGirar.disabled = false;
                            });
                }
            });

            const mensajePenalizacion = '{{mensaje_penalizacion}}';

            if (mensajePenalizacion.length > 0) {
                setTimeout(() => {
                    if (typeof soundManager !== 'undefined') {soundManager.play('alert')};
                    Swal.fire({
                        title: '¡Partida Abandonada!',
                        text: mensajePenalizacion,
                        icon: 'error',
                        confirmButtonText: 'Continuar',
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    });
                }, 300);
            }
        }, 100);
    }
</script>
