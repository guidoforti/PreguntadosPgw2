<div class="container my-5 text-center">
    <h1 class="display-4">¡Gira la ruleta!</h1>

    <div id="ruleta-wrapper" class="my-4">
        <div id="ruleta-puntero">▼</div>
        <canvas id="miRuleta" width="450" height="450">
            Tu navegador no soporta Canvas.
        </canvas>
    </div>

    <button id="botonGirar" class="btn btn-primary btn-lg px-5 d-block mx-auto">
        ¡GIRAR!
    </button>

    <form id="formRuleta" action="/jugarPartida/guardarCategoria" method="POST" class="d-none">
        <input type="hidden" name="categoria_elegida" id="categoria_elegida">
    </form>

</div>

<style>

    #ruleta-wrapper {
        position: relative;
        display: inline-block;
    }

    /* El puntero (flecha) */
    #ruleta-puntero {
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 99;


        font-size: 40px;
        color: #333;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/zarocknz/javascript-winwheel@2.8.0/Winwheel.min.js"></script>

<script>
    const categoriasJSON = '{{{ categorias_json }}}';
    const categorias = JSON.parse(categoriasJSON);

    let segmentos = categorias.map(cat => {
        return {
            'id': cat.categoria_id,
            'fillStyle': cat.color_hex,
            'text': cat.nombre
        };
    });

    console.log(segmentos);

    function ruletaTermino(segmentoElegido) {
        Swal.fire({
            title: 'Categoría: ' + segmentoElegido.text,
            text: 'Las próximas 2 preguntas serán de esta categoría.',
            icon: 'info',
            confirmButtonText: '¡Vamos!'
        }).then(() => {
            document.getElementById('formRuleta').submit();
        });
    }

    let ruleta = new Winwheel({
        'canvasId'      :   'miRuleta',
        'pointerAngle'  :   0,
        'numSegments'   :   segmentos.length,
        'outerRadius'   :   212,
        'textFontSize'  :   16,
        'segments'      :   segmentos,
        'animation'     :
                        {
                            'type'              :   'spinToStop',
                            'duration'          :   5,
                            'spins'             :   3,
                            'callbackFinished'  :   ruletaTermino
                        }
    });

    const botonGirar = document.getElementById('botonGirar');
    let girando = false;

    botonGirar.addEventListener('click', () => {
        if (!girando){
            girando = true;
            botonGirar.innerText = 'Girando...';
            botonGirar.disabled = true;

            fetch('/jugarPartida/obtenerCategoriaParaGiro', { method: 'POST' })
                .then(r => r.json())
                .then(categoria => {
                    if (categoria.error) throw new Error(categoria.error);

                    // Encontrar el índice (1-based) del segmento por ID
                    let segIndex = -1;
                    for (let i = 1; i <= ruleta.numSegments; i++) {
                        const s = ruleta.segments[i];
                        if (s && s.id === categoria.categoria_id) {
                            segIndex = i;
                            break;
                        }
                    }
                    if (segIndex === -1) {
                        console.error('No se encontró el segmento para la categoría', categoria);
                        ruleta.startAnimation();
                        return;
                    }

                    // Calcular un ángulo válido dentro del segmento
                    const stopAt = ruleta.getRandomForSegment(segIndex);
                    ruleta.animation.stopAngle = stopAt;
                    ruleta.startAnimation();
                })
                .catch(err => {
                    console.error('Error al obtener categoría:', err);
                    Swal.fire('Error', 'No se pudo obtener la categoría, intenta de nuevo.', 'error');
                    girando = false;
                    botonGirar.innerText = '¡GIRAR!';
                    botonGirar.disabled = false;
                });
        }
    });

    const mensajePenalizacion = '{{mensaje_penalizacion}}';

    if (mensajePenalizacion.length > 0) {
        setTimeout(() => {
            Swal.fire({
                title: '¡Partida Abandonada!',
                text: mensajePenalizacion,
                icon: 'error',
                confirmButtonText: 'Continuar',
                allowOutsideClick: false,
                allowEscapeKey: false
            });
        }, 100);
    }
</script>
