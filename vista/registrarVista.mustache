<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Registro de Usuario</h4>
                </div>
                <div class="card-body">
                <!-- Mensajes de éxito o error -->
                    {{#exito}}
                        <div class="alert alert-success text-center">{{exito}}</div>
                    {{/exito}}

                    {{#error}}
                        <div class="alert alert-danger text-center">{{error}}</div>
                    {{/error}}
                    <form id="formRegistro" action="/ProyectoGrupo2/registro/registrar" method="POST" enctype="multipart/form-data">
                        <!-- Nombre Completo -->
                        <div class="mb-3">
                            <label for="nombreCompleto" class="form-label">Nombre Completo</label>
                            <input type="text" class="form-control" id="nombreCompleto" name="nombreCompleto" required
                                   minlength="3" maxlength="100">
                        </div>

                        <!-- Año de Nacimiento -->
                        <div class="mb-3">
                            <label for="anioNacimiento" class="form-label">Año de Nacimiento</label>
                            <input type="number" class="form-control" id="anioNacimiento" name="anioNacimiento"
                                    max="{{anioActual}}">
                        </div>

                        <!-- Sexo -->
                        <div class="mb-3">
                            <label class="form-label">Sexo</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sexo" id="masculino" value="M" required>
                                <label class="form-check-label" for="masculino">Masculino</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sexo" id="femenino" value="F">
                                <label class="form-check-label" for="femenino">Femenino</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sexo" id="noEspecificar" value="X">
                                <label class="form-check-label" for="noEspecificar">Prefiero no cargarlo</label>
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="mb-3">
                            <label for="email" class="form-label">Correo Electrónico</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>

                        <!-- Nombre de Usuario -->
                        <div class="mb-3">
                            <label for="nombreUsuario" class="form-label">Nombre de Usuario</label>
                            <input type="text" class="form-control" id="nombreUsuario" name="nombreUsuario" required
                                   minlength="4" maxlength="30" pattern="[A-Za-z0-9_]+">
                            <div class="form-text">Solo letras, números y guiones bajos</div>
                        </div>

                        <!-- Contraseña -->
                        <div class="mb-3">
                            <label for="password" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="password" name="password" required
                                   minlength="8" pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).+$">
                            <div class="form-text">Mínimo 8 caracteres, al menos una mayúscula, una minúscula y un número</div>
                        </div>

                        <!-- Confirmar Contraseña -->
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirmar Contraseña</label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                            <div id="passwordMatch" class="invalid-feedback">Las contraseñas no coinciden</div>
                        </div>

                        <!-- Foto de Perfil -->
                        <div class="mb-4">
                            <label for="fotoPerfil" class="form-label">Foto de Perfil (opcional)</label>
                            <input class="form-control" type="file" id="fotoPerfil" name="fotoPerfil" accept="image/*">
                            <div class="form-text">Formatos aceptados: JPG, PNG, GIF. Tamaño máximo: 2MB</div>
                        </div>

                        <!-- Seleccion de Ubicación -->

                        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
                        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
                        <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
                        <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

                        <div class="mb-4">
                            <label class="form-label">Seleccioná tu ubicación</label>
                            <div id="map" style="height: 300px;"></div>
                        </div>

                        <input type="hidden" name="latitud" id="latitud">
                        <input type="hidden" name="longitud" id="longitud">
                        <input type="hidden" name="direccion" id="direccion">

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Registrarse</button>
                            <a href="/ProyectoGrupo2/login/loginForm" class="btn btn-outline-secondary">¿Ya tienes cuenta? Inicia Sesión</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<script>

    const password = document.getElementById('password');
    const confirmPassword = document.getElementById('confirmPassword');
    const form = document.getElementById('formRegistro');

    function validatePassword() {
        if (password.value !== confirmPassword.value) {
            confirmPassword.setCustomValidity("Las contraseñas no coinciden");
            confirmPassword.classList.add('is-invalid');
            return false;
        } else {
            confirmPassword.setCustomValidity('');
            confirmPassword.classList.remove('is-invalid');
            return true;
        }
    }


    password.onchange = validatePassword;
    confirmPassword.onkeyup = validatePassword;


    form.onsubmit = function(e) {
        if (!validatePassword()) {
            e.preventDefault();
            return false;
        }
        return true;
    };


    document.addEventListener('DOMContentLoaded', function() {
        const anioActual = new Date().getFullYear();
        document.getElementById('anioNacimiento').max = anioActual - 1;

        // Javascript del Mapa
        let map = L.map('map').setView([-34.6037, -58.3816], 13);
        let marker;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        L.Control.geocoder({
            geocoder: L.Control.Geocoder.nominatim({
                serviceUrl: 'http://localhost/ProyectoGrupo2/proxyNominatim.php?'
            }),
            defaultMarkGeocode: false
        })
                .on('markgeocode', function (e){
                    let latlng = e.geocode.center;

                    map.setView(latlng, 15);

                    if(marker){
                        marker.setLatLng(latlng);
                    } else {
                        marker = L.marker(latlng).addTo(map);
                    }

                    document.getElementById('latitud').value = latlng.lat;
                    document.getElementById('longitud').value = latlng.lng;
                    document.getElementById('direccion').value = e.geocode.name;
                })
                .addTo(map);
    })
</script>